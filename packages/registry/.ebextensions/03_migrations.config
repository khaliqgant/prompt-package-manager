# Run database migrations on deployment
# Only runs on the leader instance to avoid race conditions

container_commands:
  01_install_dependencies:
    command: "npm ci --only=production"
    leader_only: true

  02_run_migrations:
    command: "npm run migrate"
    leader_only: true
    env:
      DATABASE_URL: $DATABASE_URL

  03_verify_schema:
    command: |
      echo "Verifying database schema..."
      psql $DATABASE_URL -c "\dt" || echo "Could not verify schema"
    leader_only: true
    ignoreErrors: true
